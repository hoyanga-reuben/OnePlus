{% extends "base.html" %}
{% block content %}

<style>
    .verification-card {
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .proof-box {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
    }
    .action-button {
        padding: 10px 25px;
        font-weight: 600;
    }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="verification-card p-4">
                <h2 class="mb-4 text-center">Verify Membership Payment <span class="badge bg-primary">#{{ payment.id }}</span></h2>
                <hr>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="fw-bold text-success">Member Details</h5>
                        <p class="mb-1"><strong>Username:</strong> {{ payment.user.username }}</p>
                        <p class="mb-1"><strong>Full Name:</strong> {{ payment.user.get_full_name|default:"N/A" }}</p>
                        <p class="mb-1"><strong>Email:</strong> {{ payment.user.email }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5 class="fw-bold text-primary">Payment Information</h5>
                        <p class="mb-1"><strong>Amount Claimed:</strong> <span class="text-success fw-bold">TZS {{ payment.amount_paid|floatformat:0 }}</span></p>
                        <p class="mb-1"><strong>Transaction Ref:</strong> {{ payment.reference|default:"N/A" }}</p>
                        <p class="mb-1"><strong>Date Member Paid:</strong> {{ payment.date_paid|default:"N/A" }}</p>
                        <p class="mb-1"><strong>Date Submitted:</strong> {{ payment.date_submitted|date:"M j, Y H:i" }}</p>
                    </div>
                </div>

                <h5 class="fw-bold text-danger mt-4 mb-3">Payment Proof (Slip/Screenshot)</h5>
                <div class="proof-box text-center">
                    {% if payment.proof %}
                        {% with file_ext=payment.proof.url|slice:"-3:" %}
                            {% if file_ext == "pdf" %}
                                <a href="{{ payment.proof.url }}" target="_blank" class="btn btn-info btn-sm mb-2">
                                    <i class="bi bi-file-earmark-pdf"></i> View PDF Proof
                                </a>
                                <div class="text-muted small">
                                    File Type: PDF. Click to open in new tab.
                                </div>
                            {% else %}
                                <img src="{{ payment.proof.url }}" class="img-fluid rounded" style="max-height: 400px; object-fit: contain;" alt="Payment Proof">
                                <div class="mt-2 text-muted small">
                                    File Type: Image. <a href="{{ payment.proof.url }}" target="_blank">View Full Image</a>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <p class="text-muted mb-0">No payment slip uploaded by member.</p>
                        <p class="text-danger small">Verification must rely on the Reference Number and bank statement.</p>
                    {% endif %}
                </div>

                <hr class="my-4">

                {% if payment.status == 'pending' %}
                    <h4 class="text-center mb-4">Verification Action</h4>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="verify">
                            <button type="submit" class="btn btn-success action-button">
                                <i class="bi bi-check-circle me-2"></i> Verify and Activate Member
                            </button>
                        </form>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="reject">
                            <button type="submit" class="btn btn-danger action-button">
                                <i class="bi bi-x-octagon me-2"></i> Reject Payment
                            </button>
                        </form>
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        This payment is already <strong>{{ payment.get_status_display }}</strong>.
                        <p class="mb-0 small">Verified by {{ payment.verified_by.username|default:"System" }} on {{ payment.verified_at|date:"M j, Y H:i" }}</p>
                    </div>
                {% endif %}
                
                <div class="text-center mt-3">
                    <a href="{% url 'payment_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Payments List
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
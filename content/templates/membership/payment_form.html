{% extends "base.html" %}
{% load static %}
{% block content %}

<style>
  /* === STYLES === */
  .payment-header {
    background: linear-gradient(90deg, #00563f, #008751);
    color: white;
    border-radius: 12px;
    padding: 25px 30px;
    margin-bottom: 30px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  }

  .card {
    border: none;
    border-radius: 15px;
    transition: 0.3s;
  }

  .bank-info {
    background: #f7f9fb;
    border-left: 5px solid #008751;
    padding: 20px;
    border-radius: 8px;
  }

  .control-number {
    font-size: 1.4rem;
    font-weight: 600;
    color: #004d40;
  }
  
  .summary-card {
    background-color: #f0fdf4; /* Greenish background for clarity */
    border: 1px solid #dcfce7;
    border-radius: 10px;
  }
  
  .list-group-item.verified {
    background-color: #ecfdf5; /* Light green */
  }
  .list-group-item.pending {
    background-color: #fffbeb; /* Light yellow */
  }
  .list-group-item.failed {
    background-color: #fef2f2; /* Light red */
  }
</style>

<div class="container py-4">
  <!-- HEADER -->
  <div class="payment-header">
    <h2 class="fw-bold mb-1">Malipo ya Ada ya Uanachama (Awamu Zinaruhusiwa)</h2>
    <p class="mb-0">Lipa ada yako ya mwaka wa sasa (TZS {{ ANNUAL_FEE|floatformat:0 }}) kwa awamu 1 mpaka 4.</p>
  </div>

  <div class="row">
    <!-- LEFT COLUMN: PAYMENT SUMMARY & BANK DETAILS -->
    <div class="col-lg-5 mb-4">
      
      <!-- MUHTASARI WA MALIPO (PAYMENT SUMMARY CARD) -->
      <div class="card shadow summary-card mb-4">
        <div class="card-header bg-success text-white fw-bold text-center py-3">
          MUHTASARI WA AKAUNTI YAKO (Mwaka {{ profile.year }})
        </div>
        <div class="card-body p-4">
          
          <div class="d-flex justify-content-between mb-2">
            <strong>Ada ya Mwaka (Inahitajika):</strong>
            <span class="fw-bold text-dark">TZS {{ ANNUAL_FEE|floatformat:0 }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <strong>Jumla Uliyolipa (Verified):</strong>
            <span class="fw-bold text-primary">TZS {{ profile.total_verified_paid_this_year|floatformat:0 }}</span>
          </div>
          
          <hr class="my-3">
          
          <!-- BALANCE / CREDIT DISPLAY -->
          <div class="d-flex justify-content-between align-items-center">
            {% if profile.current_balance > 0 %}
              <strong class="text-danger">KIASI UNACHODAIWA (SALIO):</strong>
              <span class="fw-bolder fs-5 text-danger">TZS {{ profile.current_balance|floatformat:0 }}</span>
            {% elif profile.is_overpaid %}
              <strong class="text-success">KIASI KILICHOZIDI (CREDIT):</strong>
              <span class="fw-bolder fs-5 text-success">TZS {{ profile.current_balance|floatformat:0|slice:"1:" }}</span> <!-- Ondoa alama ya minus -->
            {% else %}
               <strong class="text-success">HADHI:</strong>
               <span class="fw-bolder fs-5 text-success">UMEMALIZA ADA</span>
            {% endif %}
          </div>
          
          <hr class="my-3">
          
          <p class="text-center mb-1 small text-dark fw-bold">Hadhi ya Uanachama wa Sasa:</p>
          <div class="text-center">
              <span class="badge bg-{% if profile.is_active_member %}success{% elif profile.total_verified_paid_this_year > 0 %}warning{% else %}secondary{% endif %} px-3 py-2">
                  {{ profile.current_status_label }}
              </span>
              {% if profile.is_active_member %}
                  <p class="small text-muted mt-1 mb-0">Unaisha: {{ profile.expiry_date|date:"F j, Y" }}</p>
              {% endif %}
          </div>

        </div>
      </div>

      <!-- BANK INFO CARD -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white fw-bold text-center">
          Taarifa za Malipo ya Benki
        </div>
        <div class="card-body">
          <div class="bank-info">
            <p class="mb-1"><strong>Benki:</strong> {{ bank_info.bank_name }}</p>
            <p class="mb-1"><strong>Jina la Akaunti:</strong> {{ bank_info.account_name }}</p>
            <p class="mb-1"><strong>Nambari ya Akaunti:</strong> {{ bank_info.account_number }}</p>
            <hr>
            <p class="mb-1"><strong>Nambari yako ya Kumbukumbu (Control No):</strong></p>
            <div class="control-number text-center p-2 border rounded bg-white text-primary">
                {{ bank_info.reference_hint }}
            </div>
          </div>
          <p class="small text-muted mb-0 mt-3 text-center">
            ⚠️ Hakikisha unatumia Control Number hii kama kumbukumbu ya malipo.
          </p>
        </div>
      </div>
      
    </div>

    <!-- RIGHT COLUMN: PAYMENT FORM & LIST OF INSTALLMENTS -->
    <div class="col-lg-7">
      
      <!-- PAYMENT FORM -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white fw-bold">Wasilisha Malipo ya Awamu (Installment)</div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}

          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="mb-3">
              <label for="{{ form.amount.id_for_label }}" class="form-label">{{ form.amount.label }}</label>
              {{ form.amount }}
              <small class="text-muted d-block mt-1">{{ form.amount.help_text }}</small>
              {% if form.amount.errors %}<div class="text-danger small">{{ form.amount.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.reference.id_for_label }}" class="form-label">{{ form.reference.label }}</label>
              {{ form.reference }}
              <small class="text-muted d-block mt-1">Nambari ya manunuzi ya benki au Control Number.</small>
              {% if form.reference.errors %}<div class="text-danger small">{{ form.reference.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.date_paid.id_for_label }}" class="form-label">{{ form.date_paid.label }}</label>
              {{ form.date_paid }}
              {% if form.date_paid.errors %}<div class="text-danger small">{{ form.date_paid.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.proof.id_for_label }}" class="form-label">{{ form.proof.label }}</label>
              <div class="upload-box text-center p-3">
                {{ form.proof }}
                <small class="text-muted d-block mt-2">Ni hiari (optional), lakini inasaidia sana katika uhakiki.</small>
              </div>
              {% if form.proof.errors %}<div class="text-danger small">{{ form.proof.errors }}</div>{% endif %}
            </div>

            <div class="text-end mt-4">
              <button type="submit" class="btn btn-success px-5 py-2 fw-bold">
                <i class="bi bi-send-fill me-2"></i> Wasilisha kwa Uhakiki
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- ALL PAYMENTS LIST -->
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white fw-bold">Historia Yako Ya Malipo Yote</div>
        <div class="card-body p-0">
          {% if all_payments %}
            <ul class="list-group list-group-flush">
              {% for payment in all_payments %}
                <li class="list-group-item d-flex justify-content-between align-items-start small p-3 list-group-item-{{ payment.status }}">
                  <div>
                    <strong class="d-block">Awamu ya {{ forloop.counter }} (Mwaka {{ payment.year }})</strong>
                    <span class="text-muted d-block">Submitted: {{ payment.date_submitted|date:"M j, Y H:i" }}</span>
                    {% if payment.reference %}
                        <span class="text-muted small">Ref: {{ payment.reference }}</span>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <span class="fw-bold fs-6">TZS {{ payment.amount_paid|floatformat:0 }}</span>
                    <span class="badge bg-{% if payment.status == 'verified' %}success{% elif payment.status == 'pending' %}warning text-dark{% else %}danger{% endif %} d-block mt-1">
                        {{ payment.get_status_display }}
                    </span>
                    {% if payment.proof %}
                        <span class="badge bg-info mt-1">Slip <i class="bi bi-paperclip"></i></span>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-center text-muted p-4 mb-0 small">Hujaanza kufanya malipo yoyote bado.</p>
          {% endif %}
        </div>
      </div>
      
    </div>
  </div>
</div>

{% endblock %}